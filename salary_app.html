<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Lương Hàng Tháng</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        h1 {
            text-align: center;
            color: #ffffff;
        }
        .month-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        .month-selector select {
            padding: 10px;
            font-size: 16px;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            border-bottom: 2px solid #ffffff;
            padding-bottom: 5px;
            color: #ffffff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #555;
            padding: 8px;
            text-align: center;
            color: #ffffff;
        }
        th {
            background-color: #333;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .calculate-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .calculate-btn:hover {
            background-color: #45a049;
        }
        .results {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            border-left: 6px solid #2196F3;
            color: #ffffff;
        }
        .overtime-log {
            display: block;
            overflow-x: auto;
            max-height: 400px;
            border: 1px solid #555;
        }
        .overtime-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #1e1e1e;
            color: #ffffff;
        }
        .overtime-table th, .overtime-table td {
            border: 1px solid #555;
            padding: 8px;
            text-align: center;
        }
        .overtime-table th {
            background-color: #333;
            position: sticky;
            top: 0;
        }
        .overtime-table input {
            width: 60px;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bảng Lương Hàng Tháng & Chấm Công Tăng Ca</h1>
        
        <div class="month-selector">
            <label for="month">Chọn Tháng: </label>
            <select id="month" onchange="generateDays(); loadData().then(() => calculateAll()).catch(console.error); saveData().catch(console.error);">
                <option value="1">Tháng 1</option>
                <option value="2">Tháng 2</option>
                <option value="3">Tháng 3</option>
                <option value="4">Tháng 4</option>
                <option value="5">Tháng 5</option>
                <option value="6">Tháng 6</option>
                <option value="7">Tháng 7</option>
                <option value="8">Tháng 8</option>
                <option value="9">Tháng 9</option>
                <option value="10">Tháng 10</option>
                <option value="11">Tháng 11</option>
                <option value="12">Tháng 12</option>
            </select>
        </div>

        <div class="section">
            <h2>Chấm Công Tăng Ca</h2>
            <p>Nhập số giờ tăng ca cho mỗi ngày (từ ngày 25 tháng trước đến ngày 24 tháng này):</p>
            <div id="overtime-log" class="overtime-log">
                <!-- Days will be generated by JS -->
            </div>
            <button class="calculate-btn" onclick="calculateOvertime()">Tính Tổng Tăng Ca</button>
            <div id="overtime-results" class="results" style="display: none;">
                <h3>Kết Quả Tăng Ca</h3>
                <p>Tổng OT 150%: <span id="ot150">0</span> giờ</p>
                <p>Tổng OT 200%: <span id="ot200">0</span> giờ</p>
                <p>Tổng OT 300%: <span id="ot300">0</span> giờ</p>
            </div>
        </div>

        <div class="section">
            <h2>Lưu Trữ Dữ Liệu</h2>
            <p style="color: #ccc; font-size: 14px;">Dữ liệu được lưu tự động online qua Firebase. Không cần xuất/nhập thủ công.</p>
        </div>
            <table>
                <tr>
                    <th>Mục</th>
                    <th>Giá Trị</th>
                </tr>
                <tr>
                    <td>Lương Cơ Bản (LCB)</td>
                    <td>6,500,000 VND</td>
                </tr>
                <tr>
                    <td>Bảo Hiểm Xã Hội (BHXH)</td>
                    <td>520,000 VND</td>
                </tr>
                <tr>
                    <td>Bảo Hiểm Y Tế (BHYT)</td>
                    <td>97,500 VND</td>
                </tr>
                <tr>
                    <td>Bảo Hiểm Thất Nghiệp (BHTN)</td>
                    <td>65,000 VND</td>
                </tr>
                <tr>
                    <td>Công Đoàn</td>
                    <td>44,100 VND</td>
                </tr>
                <tr>
                    <td>Tiền Tăng Ca (OVT)</td>
                    <td id="ovt-amount">0 VND</td>
                </tr>
                <tr>
                    <td>Thưởng Hè (10% LCB nếu tháng 5-8)</td>
                    <td id="bonus-amount">0 VND</td>
                </tr>
                <tr>
                    <td><strong>Thực Nhận</strong></td>
                    <td id="net-salary"><strong>0 VND</strong></td>
                </tr>
            </table>
            <button class="calculate-btn" onclick="calculateSalary()">Tính Lương</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <script>
        // Khai báo các biến global trước
        let ot150Total = 0;
        let ot200Total = 0;
        let ot300Total = 0;

        const lcb = 6500000;
        const bhxh = 520000;
        const bhyt = 97500;
        const bhtn = 65000;
        const congDoan = 44100;
        const ot150Rate = 46875;
        const ot200Rate = 62500;
        const bonusPercent = 0.1;

        // Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyDHxmItkQJzX99EEtRIs9REdSu8mvBx77M",
          authDomain: "webbill-db641.firebaseapp.com",
          projectId: "webbill-db641",
          storageBucket: "webbill-db641.firebasestorage.app",
          messagingSenderId: "633276429584",
          appId: "1:633276429584:web:f774f40a67cfe59a9a2195",
          measurementId: "G-805GHPRGCP"
        };

        // Initialize Firebase (after scripts load)
        let db = null;
        setTimeout(() => {
            if (typeof firebase !== 'undefined') {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase initialized');
            }
        }, 500);


        // Generate days for overtime logging (from 25th of previous month to 24th of selected month)
        window.generateDays = function() {
            const logDiv = document.getElementById('overtime-log');
            logDiv.innerHTML = `
                <table class="overtime-table">
                    <thead>
                        <tr>
                            <th>Ngày</th>
                            <th>OT 150%</th>
                            <th>OT 200%</th>
                            <th>OT 300%</th>
                        </tr>
                    </thead>
                    <tbody id="overtime-tbody"></tbody>
                </table>
            `;
            const tbody = document.getElementById('overtime-tbody');

            const month = parseInt(document.getElementById('month').value);
            const year = 2026; // Assuming current year

            let startMonth = month - 1;
            let startYear = year;
            if (startMonth === 0) {
                startMonth = 12;
                startYear = year - 1;
            }

            const startDate = new Date(startYear, startMonth - 1, 25);
            const endDate = new Date(year, month - 1, 24);

            let currentDate = new Date(startDate);
            let dayCount = 0;
            while (currentDate <= endDate) {
                dayCount++;
                const dateStr = currentDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td><input type="number" id="ot150-${dayCount}" placeholder="0" min="0" step="0.5" onchange="calculateAll(); saveData().catch(console.error)"></td>
                    <td><input type="number" id="ot200-${dayCount}" placeholder="0" min="0" step="0.5" onchange="calculateAll(); saveData().catch(console.error)"></td>
                    <td><input type="number" id="ot300-${dayCount}" placeholder="0" min="0" step="0.5" onchange="calculateAll(); saveData().catch(console.error)"></td>
                `;
                tbody.appendChild(row);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            // Store dayCount for calculation
            window.dayCount = dayCount;
        }

        function calculateOvertime() {
            ot150Total = 0;
            ot200Total = 0;
            ot300Total = 0;
            for (let i = 1; i <= window.dayCount; i++) {
                const ot150 = document.getElementById(`ot150-${i}`);
                const ot200 = document.getElementById(`ot200-${i}`);
                const ot300 = document.getElementById(`ot300-${i}`);
                if (ot150) ot150Total += parseFloat(ot150.value) || 0;
                if (ot200) ot200Total += parseFloat(ot200.value) || 0;
                if (ot300) ot300Total += parseFloat(ot300.value) || 0;
            }
            document.getElementById('ot150').textContent = ot150Total.toFixed(1);
            document.getElementById('ot200').textContent = ot200Total.toFixed(1);
            document.getElementById('ot300').textContent = ot300Total.toFixed(1);
            document.getElementById('overtime-results').style.display = 'block';
        }

        function calculateSalary() {
            const month = parseInt(document.getElementById('month').value);
            const ovt = (ot150Rate * ot150Total) + (ot200Rate * ot200Total); // Assuming OT 300% not paid or different rate
            const bonus = (month >= 5 && month <= 8) ? bonusPercent * lcb : 0;
            const deductions = bhxh + bhyt + bhtn + congDoan;
            const net = lcb + ovt + bonus - deductions;

            document.getElementById('ovt-amount').textContent = ovt.toLocaleString() + ' VND';
            document.getElementById('bonus-amount').textContent = bonus.toLocaleString() + ' VND';
            document.getElementById('net-salary').innerHTML = '<strong>' + net.toLocaleString() + ' VND</strong>';
        }

        function calculateAll() {
            calculateOvertime();
            calculateSalary();
        }

        // Expose to global scope
        window.calculateOvertime = calculateOvertime;
        window.calculateSalary = calculateSalary;
        window.calculateAll = calculateAll;

        async function saveData() {
            const month = document.getElementById('month').value;
            const data = { overtimeData: {} };
            for (let i = 1; i <= window.dayCount; i++) {
                const ot150 = document.getElementById(`ot150-${i}`);
                const ot200 = document.getElementById(`ot200-${i}`);
                const ot300 = document.getElementById(`ot300-${i}`);
                if (ot150) data.overtimeData[`ot150-${i}`] = ot150.value;
                if (ot200) data.overtimeData[`ot200-${i}`] = ot200.value;
                if (ot300) data.overtimeData[`ot300-${i}`] = ot300.value;
            }
            try {
                await db.collection('users').doc(`month-${month}`).set(data);
                console.log('Dữ liệu đã lưu online!');
            } catch (error) {
                console.error('Lỗi lưu dữ liệu:', error);
            }
        }

        async function loadData() {
            const month = document.getElementById('month').value;
            try {
                const docSnap = await db.collection('users').doc(`month-${month}`).get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    for (let i = 1; i <= window.dayCount; i++) {
                        const ot150 = document.getElementById(`ot150-${i}`);
                        const ot200 = document.getElementById(`ot200-${i}`);
                        const ot300 = document.getElementById(`ot300-${i}`);
                        if (ot150) ot150.value = data.overtimeData[`ot150-${i}`] || '';
                        if (ot200) ot200.value = data.overtimeData[`ot200-${i}`] || '';
                        if (ot300) ot300.value = data.overtimeData[`ot300-${i}`] || '';
                    }
                }
            } catch (error) {
                console.error('Lỗi tải dữ liệu:', error);
            }
        }

        // Expose to global scope
        window.saveData = saveData;
        window.loadData = loadData;

        function exportData() {
            alert('Dữ liệu được lưu online tự động. Không cần xuất.');
        }

        function importData() {
            alert('Dữ liệu được tải online tự động. Không cần nhập.');
        }

        window.exportData = exportData;
        window.importData = importData;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.generateDays();
            setTimeout(() => {
                window.loadData().then(() => window.calculateAll()).catch(console.error);
            }, 500);
        });
    </script>
</body>
</html>
